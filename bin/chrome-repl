#! /usr/bin/env ruby
require 'chrome'
require 'readline'
require 'pp'
require 'optparse'

def print_response(data)
  if data.empty?
    puts 'nil'
  elsif data['error']
    puts data['error']['stack']
  elsif data['success']
    pp data['success']
  elsif data['log']
    puts data['log']
  end
end

def print_all_response(client)
  client.read_all_response.each do |header, resp|
    print_response(resp['data'])
  end
end

extension_id = 'olppoehbaphcegdobmaipllacoammngl'
port = 9222
script = nil

parser = OptionParser.new

parser.on('--port N', Integer) do |n|
  port = n
end

parser.on('--extension ID') do |s|
  extension_id = s
end

parser.on('-e SCRIPT') do |s|
  script = s
end

parser.parse!(ARGV)

client = Chrome::Client.new('localhost', port)
extension = client.extension(extension_id)

extension.connect do |port|
  if script
    extension.post(port, script)
    print_all_response(client)
  else
    puts "Version: %s" % client.server_version
    while ln = Readline.readline('> ', true)
      extension.post(port, ln)
      print_all_response(client)
    end
  end
end
