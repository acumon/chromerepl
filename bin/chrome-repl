#! /usr/bin/env ruby
require 'chrome'
require 'readline'
require 'pp'

def print_response(data)
  if data.empty?
    puts 'nil'
  elsif data['error']
    puts data['error']['stack']
  elsif data['success']
    pp data['success']
  elsif data['log']
    puts data['log']
  end
end

EXTENSION_ID = 'bpijokngpjkacdohhbajeedhlbdhiccb' # 'olppoehbaphcegdobmaipllacoammngl'

port = ARGV.shift.to_i

client = Chrome::Client.new('localhost', port)
puts "Version: %s" % client.server_version

extension = client.extension(EXTENSION_ID)
extension.connect do |port|
  while ln = Readline.readline('> ', true)
    extension.post(port, ln)
    client.read_all_response.each do |header, resp|
      print_response(resp['data'])
    end
  end
end
